# Securing pods with identities using the Venafi Jetstack cert-manager CSI Driver

## Installing the Venafi Jetstack cert-manager CSI Driver

From the top level directory run the following 
```
make install-cert-manager-CSI-driver
```
This will install `cert-manager-CSI-driver` that will provide the ability to define `volume` attributes that will leverage `cert-manager` issuer to inject certificates into the pod. 

**NOTE** `cert-manager-CSI-driver` is `DaemonSet` and as such you will see a pod for each `Node` in your cluster. When a `pod` is scheduled by a `Node` the relevant certiicate material is injected into the pod's epheremal file system.

Run the following to validate that the addtional module is installed.
```
kubectl get pods -n jetstack-secure
```
The `cert-manager-csi-driver` release should be installed and it's the state should be `Ready=3/3`

```
NAME                                                         READY   STATUS    RESTARTS   AGE
agent-6bf697664b-ww9xn                                       1/1     Running   0          11m
cert-manager-75b4649b6f-hcwkc                                1/1     Running   0          21m
cert-manager-approver-policy-864d6bc45c-wvmcb                1/1     Running   0          21m
cert-manager-cainjector-5d7485d9d8-h85wn                     1/1     Running   0          21m
cert-manager-csi-driver-ct5d5                                3/3     Running   0          9s
cert-manager-webhook-fb6b96c7-wx22d                          1/1     Running   0          21m
cert-sync-to-venafi-cert-discovery-venafi-5c5c5865c5-wjhs7   2/2     Running   0          41s
```

The above output is from a single node cluster and as such has one csi-driver `pod`. What you see may be different.

Validate that the CSIDriver is also avaialble in cluster. Run, 
```
kubectl get CSIDriver
```
All the CSIDrivers in the cluster will get listed along with `csi.cert-manager.io`

```
NAME                  ATTACHREQUIRED   PODINFOONMOUNT   STORAGECAPACITY   TOKENREQUESTS   REQUIRESREPUBLISH   MODES       AGE
csi.cert-manager.io   true             true             false             <unset>         false               Ephemeral   12s
```

## Creating the required policies to fulfil certificate requests initiated by CSI Driver for the first sample application

Change to the directory `cert-manager-csi`
```
cd cert-manager-csi
```
The cert-manager in the cluster does not have it's approver controller enabled. As such, an appropriate policy is required for `CertificateRequests` to be approved before they are injected. If a `CertificateRequest` is `Denied` the pod will fail to start. 

For the first example to validate CSI Driver, run the following to create a `CertificateRequestPolicy` called `allow-self-signed-issuer-in-ns-sandbox` and `allow-self-signed-issuer-for-pods-in-ns-sandbox`. Additionally a `ClusterRole` and `ClusterRoleBinding` allowing specfic requestors to have access to the policies. This is for a sample that will use `self-signed` issuer in the `sandbox` namespace.  
 
```
make create-policy-and-rbac
```

Run the following to validate that the `CertificateRequestPolicies` are created. 

```
kubectl get crp
```
You will see the following. Validate that the state of the policy says `Ready=True`

```
NAME                                              READY   AGE
allow-self-signed-issuer-for-pods-in-ns-sandbox   True    11s
allow-self-signed-issuer-in-ns-sandbox            True    11s
cert-policy-for-apps-in-sandbox                   True    48m
```

In addtion to the two policies we just created, you will also see a policy that we created while validating a different use case. 


## Deploying the first sample application
From the `cert-manager-csi` directory run
```
make create-sample-app
```

In addition to creating a CA issuer, a Certificate a busybox pod is deployed with replica of 5. To review the `Deployment` click [here](https://raw.githubusercontent.com/cert-manager/csi-driver/main/deploy/example/example-app.yaml)

Run
```
kubectl get pods -n sandbox
```
The output you see will look something like this

```
NAME                          READY   STATUS    RESTARTS   AGE
my-csi-app-85c458479c-cj45j   1/1     Running   0          111s
my-csi-app-85c458479c-khvbt   1/1     Running   0          111s
my-csi-app-85c458479c-ljfpc   1/1     Running   0          111s
my-csi-app-85c458479c-mkjbc   1/1     Running   0          111s
my-csi-app-85c458479c-vwmwd   1/1     Running   0          111s
```
Validate that the cert is available in the defined `volumeMount` by simply running the below. Replace the name of the pod with one of the 5 pods in your cluster.

```
kubectl -n sandbox exec -it my-csi-app-85c458479c-cj45j -- ls /tls
```
The output will be 
```
ca.crt   crt.p12  tls.crt  tls.key
```

## Creating the required policies to fulfil certificate requests initiated by CSI Driver for the first sample application

## Deploying the first sample application
