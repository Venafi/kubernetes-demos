# CyberArk Certificate Manager for Kubernetes and Workload Identity Manager Mirror Toolkit

This directory automates mirroring of **CyberArk Certificate Manager for Kubernetes ** components into any OCI-compliant registry. Harbor is one example, but any OCI registry works.

## Contents

- `ccm-components.sh` – main mirror script (supports `mirror`, `download`, `upload`)
- `charts.txt` – static list of CCM charts + images (versions are variable refs)
- `component-versions.sh` – defines `${VARS}` (from `venctl components kubernetes manifest print-versions`)
- `env-mirror.sh` – environment variables for registry creds, platform, retries. Make a copy of `env-mirror-template.sh` to `env-mirror.sh` and update it
- `list-charts.sh` – prints all mirrored chart references (optionally as Markdown) with sample `oras` commands to verify
- `generate-helm-values.sh` – generates per-chart override values YAMLs pointing workloads to mirrored images (uses tags from `charts.txt`)

## Prerequisites

- Tools:
  - [Helm](https://helm.sh/) v3.8+ (with OCI support)
  - [Skopeo](https://github.com/containers/skopeo) (for images)
  - [oras](https://oras.land) (optional, to verify tags)
- Access to:
  - Source registries: `registry.venafi.cloud`, `private-registry.venafi.cloud` (or `.eu`)
  - Access to CyberArk Registry requires a image pull secret that can be generated by accessing CyberArk Certificate Manager (if you have the entitlements)
  - Destination: any OCI-compliant registry

## Workflow

### 1. Configure

Edit `env-mirror.sh` with your destination registry and robot creds:

```bash
export DST_REGISTRY="my-registry.example.com"
export DST_PROJECT="ccm-project"
export DST_USERNAME="robot$ccm-project-ci"
export DST_PASSWORD="REPLACE_ME"
# Platform and retry knobs:
export PLATFORM="linux/amd64"
export SKOPEO_RETRIES=3
```

Edit `component-versions.sh` with current versions.

### 2. Mirror directly

```bash
./ccm-components.sh mirror
```

Air-gapped:

```bash
./ccm-components.sh download
# transfer $WORKDIR
./ccm-components.sh upload
```

### 3. List mirrored charts

```bash
./list-charts.sh
```

Markdown table:

```bash
./list-charts.sh --md --out ~/tmp/ccm-charts.md
```

Verify with oras:

```bash
oras repo tags ${DST_REGISTRY}/${DST_PROJECT}/charts/cert-manager
```

### 4. Generate override values

```bash
EMIT_TAGS=auto ./generate-helm-values.sh --outdir ~/tmp/my-values
```

Generates YAMLs like:

```yaml
image:
  repository: my-registry.example.com/ccm-project/cert-manager/cert-manager-controller
  tag: v1.18.2
webhook:
  image:
    repository: my-registry.example.com/ccm-project/cert-manager/cert-manager-webhook
    tag: v1.18.2
```

Use with Helm:

```bash
helm upgrade --install cert-manager   oci://${DST_REGISTRY}/${DST_PROJECT}/charts/cert-manager   --version ${CERT_MANAGER}   -f ~/tmp/my-values/cert-manager-values.yaml
```

Use with venctl 

```bash
venctl components kubernetes manifest generate \ 
                  --region "us" \ 
                  --vcp-region "us" \ 
                  --namespace "cyberark" \ 
                  --custom-chart-repository "oci://${DST_REGISTRY}/${DST_PROJECT}/charts \
                  --cert-manager \ 
                  --cert-manager-version "${CERT_MANAGER}" \
                  --cert-manager-custom-image-registry "${DST_REGISTRY}/${DST_PROJECT}/cert-manager" \
                  --cert-manager-values-files ~/tmp/my-values/cert-manager-values.yaml \
                  --image-pull-secret-names registry-creds \
                  > "cyberark-manifests.yaml"

```
## Notes

- Registry repo names are kept identical to upstream.  
- Per-image tags in `charts.txt` are respected (e.g., `trust-pkg-debian-bookworm:20230311.0`, `csi-node-driver-registrar:v2.14.0`).  
- `EMIT_TAGS` env controls whether to always emit tags, only when explicit, or never.  
- For EU/UK tenants, replace `.cloud` with `.eu` in `charts.txt`.
